{{ $prefix := (MakeIdentifier .Info.Title) }}


{{- define "handlerDecl" }}
func (server {{.prefix}}Server) _{{.prefix}}_{{.path.OperationID}}_Handler(c *gin.Context) {
    in, _ := Make{{.path.OperationID}}Req(c)
    server.Srv.{{.path.OperationID}}(in, c)
}
{{- end}}



{{- define "reqStructDecl" }}
    {{- $structName := (print .OperationID "Req") -}}
type {{ $structName }} struct {
    {{- range $parameter := .Parameters}}
    {{- $parameterName := (MakeIdentifier $parameter.Name) }}
    {{- $parameterType := (ConvertType $parameter.Schema) }}
    {{ $parameterName }} {{ $parameterType }}
    {{- end}}

    {{- with .RequestBody }}
        {{- range $contentType, $body := .Content }}
    Body {{ ConvertType $body.Schema }}
        {{- end}}
    {{- end}}
}
{{- end }}

{{- define "constructorDecl" }}
      {{- $structName := (print .OperationID "Req") }}

      {{- with ToConstructorType . -}}

func Make{{ $structName }}(c *gin.Context) (res {{$structName}}, err error) {
    var errors strings.Builder

	// URI binding
	for _, param := range c.Params {
		switch param.Key {
		{{- range $n, $e := .InPath }}
		case "{{ $n }}":
          res.{{ MakeIdentifier $n }} = param.Value

		{{- end}}

		default:
			fmt.Fprintf(&errors, "Unexpected uri parameter: `%s`", param.Key)
		}
	}

    {{- range $n, $e := .InQuery }}
        {{- if eq $e.Type "integer" }}
            {{- if eq $e.Format "int64" }}
    res.{{ MakeIdentifier $n }} = strconv.ParseInt(c.Query("{{ $n }}"), 10, 64)
            {{- else}}
    res.{{ MakeIdentifier $n }} = strconv.Atoi(c.Query("{{ $n }}"))
            {{- end}}
        {{- else}}
    res.{{ MakeIdentifier $n }} = c.Query("{{ $n }}")
        {{- end}}
	{{- end}}

    {{- range $n, $e := .InHeader }}
    res.{{ MakeIdentifier $n }} = c.Request.Header.Get("{{ $n }}")
	{{- end}}

	{{- if .BodyRequired }}

    if c.Request == nil || c.Request.Body == nil {
        fmt.Fprintf(&errors, "Body is absent")
    }
    {{- end}}

    {{- if not .Body }}

    if c.Request == nil || c.Request.Body != nil {
        fmt.Fprintf(&errors, "Unexpected body")
    }
    {{- end}}

    {{- range $contentType, $e := .Body }}

    switch ct := c.Request.Header.Get("Content-Type"); ct {
    case "application/json":
        dec := json.NewDecoder(c.Request.Body)
    	if err := dec.Decode(&res.Body); err != nil {
    		fmt.Fprintf(&errors, "Cant parse JSON") //TODO: investigate for more detailed error
    	}
    default:
        fmt.Fprintf(&errors, "Unsupported content-type: %v", ct)
    }
    {{- end}}

	if errors.Len() > 0 {
		err = fmt.Errorf(errors.String())
	}
	return
{{- end}}
}
{{- end}}


{{- range $url, $element := .Paths}}
    {{- with $p := .Post}}
      {{template "handlerDecl"  (dict "prefix" $prefix "path" $p ) }}
    {{- end}}

    {{- with $p := .Get}}
      {{template "handlerDecl"  (dict "prefix" $prefix "path" $p ) }}
    {{- end}}

    {{- with $p := .Delete}}
      {{template "handlerDecl"  (dict "prefix" $prefix "path" $p ) }}
    {{- end}}

    {{- with $p := .Put}}
      {{template "handlerDecl"  (dict "prefix" $prefix "path" $p ) }}
    {{- end}}

{{- end}}


{{- range $url, $element := .Paths}}
    {{- with $p := .Post}}
      {{template "reqStructDecl" $p }}
      {{template "constructorDecl" $p }}
    {{- end}}
    {{- with $p := .Get}}
      {{template "reqStructDecl" $p }}
      {{template "constructorDecl" $p }}
    {{- end}}
    {{- with $p := .Delete}}
      {{template "reqStructDecl" $p }}
      {{template "constructorDecl" $p }}
    {{- end}}
    {{- with $p := .Put}}
      {{template "reqStructDecl" $p }}
      {{template "constructorDecl" $p }}
    {{- end}}
{{- end}}
